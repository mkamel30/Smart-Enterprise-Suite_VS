generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id               String   @id @default(cuid())
  uid              String?
  email            String?
  displayName      String?
  role             String?  @default("CS_AGENT")
  // Roles: SUPER_ADMIN, MANAGEMENT, ADMIN_AFFAIRS,
  //        CENTER_MANAGER, CENTER_TECH, 
  //        CS_SUPERVISOR (مشرف خدمة العملاء), CS_AGENT (موظف خدمة العملاء)
  //        BRANCH_MANAGER (Legacy - mapped to CS_SUPERVISOR)
  canDoMaintenance Boolean  @default(false)
  password         String?
  theme            String?  @default("light")
  fontFamily       String?  @default("IBM Plex Sans Arabic")
  fontSize         String?  @default("small") // small, medium, large
  highlightEffect  Boolean  @default(true)
  notificationSound Boolean @default(true)
  mobilePush       Boolean  @default(false)
  createdAt        DateTime @default(now())
  branchId         String?
  branch           Branch?  @relation(fields: [branchId], references: [id])
}

model ClientType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
}

model Branch {
  id                 String               @id @default(cuid())
  code               String               @unique
  name               String
  address            String?
  type               String               @default("BRANCH")
  isActive           Boolean              @default(true)
  // Types: BRANCH, MAINTENANCE_CENTER, ADMIN_AFFAIRS
  
  // Hierarchy: parent branch
  parentBranchId     String?
  parentBranch       Branch?              @relation("BranchHierarchy", fields: [parentBranchId], references: [id])
  childBranches      Branch[]             @relation("BranchHierarchy")
  
  // Link branch to its maintenance center
  maintenanceCenterId String?
  maintenanceCenter   Branch?              @relation("BranchToCenter", fields: [maintenanceCenterId], references: [id])
  servicedBranches    Branch[]             @relation("BranchToCenter")
  
  // Relations
  users              User[]
  customers          Customer[]
  requests           MaintenanceRequest[]
  inventory          InventoryItem[]
  stockMovements     StockMovement[]
  payments           Payment[]
  sentTransfers      TransferOrder[]      @relation("SentTransfers")
  receivedTransfers  TransferOrder[]      @relation("ReceivedTransfers")
  warehouseSims      WarehouseSim[]
  warehouseMachines  WarehouseMachine[]
  sales              MachineSale[]
  installments       Installment[]
  machineMovements   MachineMovementLog[]
  simMovements       SimMovementLog[]
  usedPartLogs       UsedPartLog[]
  systemLogs         SystemLog[]
  posMachines        PosMachine[]
  simCards           SimCard[]
  notifications      Notification[]
  approvals          MaintenanceApproval[]
  vouchers           RepairVoucher[]
  createdAt          DateTime             @default(now())
}

model Customer {
  id              String               @id @default(cuid())
  bkcode          String               @unique
  client_name     String
  supply_office   String?
  operating_date  DateTime?
  address         String?
  contact_person  String?
  scanned_id_path String?
  national_id     String?
  dept            String?
  telephone_1     String?
  telephone_2     String?
  has_gates       Boolean?             @default(false)
  bk_type         String?
  notes           String?
  papers_date     DateTime?
  isSpecial       Boolean?             @default(false)
  clienttype      String?
  branchId        String?
  branch          Branch?              @relation(fields: [branchId], references: [id])
  sales           MachineSale[]
  requests        MaintenanceRequest[]
  machines        PosMachine[]
  simCards        SimCard[]
  payments        Payment[]
}

model MachineParameter {
  id           String @id @default(cuid())
  prefix       String @unique
  model        String
  manufacturer String
}

// Dynamic Role Permissions - allows editing from Admin UI
model RolePermission {
  id             String   @id @default(cuid())
  role           String   // CS_AGENT, CS_SUPERVISOR, etc.
  permissionType String   // 'PAGE' or 'ACTION'
  permissionKey  String   // '/requests' or 'CREATE_REQUEST'
  isAllowed      Boolean  @default(true)
  updatedAt      DateTime @updatedAt
  updatedBy      String?  // User who last updated this permission
  
  @@unique([role, permissionType, permissionKey])
}

model SparePart {
  id               String          @id @default(cuid())
  partNumber       String?
  name             String
  description      String?
  compatibleModels String?
  defaultCost      Float           @default(0)
  isConsumable     Boolean?        @default(false)
  allowsMultiple   Boolean?        @default(false)
  inventoryItems   InventoryItem[]
}

model InventoryItem {
  id       String    @id @default(cuid())
  partId   String
  quantity Int       @default(0)
  minLevel Int       @default(0)
  location String?
  branchId String?
  branch   Branch?   @relation(fields: [branchId], references: [id])
  part     SparePart @relation(fields: [partId], references: [id])
}

model MaintenanceRequest {
  id                  String               @id @default(cuid())
  customerId          String
  posMachineId        String?
  customerName        String?
  machineModel        String?
  machineManufacturer String?
  serialNumber        String?
  status              String               @default("Open")
  branchId            String?
  branch              Branch?              @relation(fields: [branchId], references: [id])
  servicedByBranchId  String?
  technician          String?
  notes               String?
  complaint           String?
  actionTaken         String?
  createdAt           DateTime             @default(now())
  closingUserId       String?
  closingUserName     String?
  closingTimestamp    DateTime?
  usedParts           String?
  receiptNumber       String?
  totalCost           Float?               @default(0)
  posMachine          PosMachine?          @relation(fields: [posMachineId], references: [id])
  customer            Customer             @relation(fields: [customerId], references: [bkcode])
  approval            MaintenanceApproval?
  vouchers            RepairVoucher[]
}

model PriceChangeLog {
  id        String   @id @default(cuid())
  partId    String
  oldCost   Float
  newCost   Float
  changedAt DateTime @default(now())
  userId    String?
}

model UsedPartLog {
  id             String   @id @default(cuid())
  requestId      String
  customerId     String
  customerName   String?
  posMachineId   String?
  technician     String?
  closedByUserId String?
  closedAt       DateTime @default(now())
  parts          String
  receiptNumber  String?
  branchId       String?
  branch         Branch?  @relation(fields: [branchId], references: [id])
}

model StockMovement {
  id          String   @id @default(cuid())
  partId      String
  type        String
  quantity    Int
  reason      String?
  requestId   String?
  userId      String?
  performedBy String?
  branchId    String?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  createdAt   DateTime @default(now())
}

model Payment {
  id            String    @id @default(cuid())
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [bkcode])
  customerName  String?
  requestId     String?
  amount        Float
  type          String?
  reason        String?
  paymentPlace  String?
  paymentMethod String?
  receiptNumber String?
  notes         String?
  userId        String?
  userName      String?
  branchId      String?
  branch        Branch?  @relation(fields: [branchId], references: [id])
  createdAt     DateTime @default(now())
}

model MachineMovementLog {
  id           String   @id @default(cuid())
  machineId    String?
  serialNumber String
  action       String
  details      String?
  performedBy  String?
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  createdAt    DateTime @default(now())
}

model SystemLog {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  action      String
  details     String?
  performedBy String?
  userId      String?
  branchId    String?
  branch      Branch?  @relation(fields: [branchId], references: [id])
  createdAt   DateTime @default(now())
}

model Installment {
  id            String      @id @default(cuid())
  saleId        String
  dueDate       DateTime
  amount        Float
  isPaid        Boolean     @default(false)
  paidAt        DateTime?
  description   String?
  paidAmount    Float?
  paymentPlace  String?
  receiptNumber String?
  branchId      String?
  branch        Branch?     @relation(fields: [branchId], references: [id])
  sale          MachineSale @relation(fields: [saleId], references: [id])
}

model MachineSale {
  id           String        @id @default(cuid())
  serialNumber String
  customerId   String
  saleDate     DateTime      @default(now())
  type         String
  totalPrice   Float
  paidAmount   Float
  status       String
  notes        String?
  branchId     String?
  branch       Branch?       @relation(fields: [branchId], references: [id])
  installments Installment[]
  customer     Customer      @relation(fields: [customerId], references: [bkcode])
}

model PosMachine {
  id           String               @id @default(cuid())
  serialNumber String               @unique
  posId        String?
  model        String?
  manufacturer String?
  customerId   String?
  isMain       Boolean?             @default(false)
  requests     MaintenanceRequest[]
  branchId     String?
  branch       Branch?              @relation(fields: [branchId], references: [id])
  customer     Customer?            @relation(fields: [customerId], references: [bkcode])
}

model SimCard {
  id           String    @id @default(cuid())
  serialNumber String    @unique
  type         String?
  customerId   String?
  branchId     String?
  branch       Branch?   @relation(fields: [branchId], references: [id])
  customer     Customer? @relation(fields: [customerId], references: [bkcode])
}

model WarehouseMachine {
  id              String   @id @default(cuid())
  serialNumber    String   @unique
  model           String?
  manufacturer    String?
  status          String   @default("NEW")
  // Status values:
  // NEW - ماكينة جديدة
  // STANDBY - مستعملة جاهزة للبيع
  // SOLD - تم بيعها
  // EXTERNAL_REPAIR - سحب من عميل للصيانة الخارجية (Legacy)
  
  // --- Maintenance Lifecycle Statuses ---
  // IN_TRANSIT - في الطريق (سواء للفرع أو المركز)
  // AT_CENTER / RECEIVED_AT_CENTER - تم الاستلام بالمركز (Ready for action)
  // ASSIGNED - تم التعيين لمختص
  // UNDER_MAINTENANCE - جاري الصيانة
  // PENDING_APPROVAL - بانتظار موافقة الفرع
  // APPROVED - تمت الموافقة
  // REJECTED - تم رفض الموافقة
  // COMPLETED - مكتملة الصيانة
  // IN_RETURN_TRANSIT - في طريق العودة للفرع
  // READY_FOR_DELIVERY - جاهزة للتسليم للعميل

  resolution      String?  // REPAIRED, SCRAPPED, RETURNED_AS_IS
  
  notes           String?
  importDate      DateTime @default(now())
  updatedAt       DateTime @updatedAt
  originalOwnerId String?
  branchId        String?
  
  // External repair tracking
  requestId       String?  // ربط بطلب الصيانة
  customerId      String?  // العميل صاحب الماكينة
  customerName    String?  // اسم العميل
  readyForPickup  Boolean  @default(false)
  
  // Service Assignment tracking (for maintenance center)
  currentAssignmentId   String?   // التعيين الحالي
  currentTechnicianId   String?   // المختص المعين
  currentTechnicianName String?   // اسم المختص
  originBranchId        String?   // الفرع الأصلي للماكينة
  
  branch          Branch?  @relation(fields: [branchId], references: [id])
  serviceAssignments ServiceAssignment[]

  // --- Quote / Proposal Fields (For Batch Workflow) ---
  proposedRepairNotes String?
  proposedParts       String?  // JSON: Proposed parts for approval
  proposedTotalCost   Float?   @default(0)
  
  repairNotes         String?
  usedParts           String?
  totalCost           Float?   @default(0)
}

model WarehouseSim {
  id           String   @id @default(cuid())
  serialNumber String   @unique
  type         String?
  status       String   @default("NEW")
  notes        String?
  importDate   DateTime @default(now())
  updatedAt    DateTime @updatedAt
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
}

model SimMovementLog {
  id           String   @id @default(cuid())
  simId        String
  serialNumber String
  action       String
  details      String?
  performedBy  String?
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  createdAt    DateTime @default(now())
}

model TransferOrder {
  id               String              @id @default(cuid())
  orderNumber      String              @unique
  waybillNumber    String?
  branchId         String?
  fromBranchId     String
  fromBranch       Branch              @relation("SentTransfers", fields: [fromBranchId], references: [id])
  toBranchId       String
  toBranch         Branch              @relation("ReceivedTransfers", fields: [toBranchId], references: [id])
  status           String              @default("PENDING")
  type             String
  driverName       String?
  driverPhone      String?
  notes            String?
  createdBy        String?
  createdByName    String?
  createdByUserId  String?
  receivedByUserId String?
  receivedAt       DateTime?
  receivedBy       String?
  receivedByName   String?
  rejectionReason  String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  items            TransferOrderItem[]
}

model TransferOrderItem {
  id              String        @id @default(cuid())
  transferOrderId String
  transferOrder   TransferOrder @relation(fields: [transferOrderId], references: [id], onDelete: Cascade)
  serialNumber    String?
  type            String?
  model           String?
  manufacturer    String?
  isReceived      Boolean       @default(false)
  receivedAt      DateTime?
  notes           String?
}

model MaintenanceApproval {
  id          String             @id @default(cuid())
  requestId   String             @unique
  request     MaintenanceRequest @relation(fields: [requestId], references: [id])
  cost        Float
  parts       String
  status      String             @default("PENDING")
  notes       String?
  branchId    String?
  branch      Branch?            @relation(fields: [branchId], references: [id])
  createdAt   DateTime           @default(now())
  respondedAt DateTime?
  respondedBy String?
}

model RepairVoucher {
  id        String             @id @default(cuid())
  code      String             @unique
  requestId String
  request   MaintenanceRequest @relation(fields: [requestId], references: [id])
  type      String
  parts     String
  totalCost Float
  branchId  String?
  branch    Branch?            @relation(fields: [branchId], references: [id])
  createdAt DateTime           @default(now())
  createdBy String?
}

model Notification {
  id        String   @id @default(cuid())
  userId    String?
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  link      String?
  type      String
  title     String
  message   String
  data      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ============================================
// Service Center Workflow Models (Enhanced)
// ============================================

// تعيين المختص للماكينة في مركز الصيانة
model ServiceAssignment {
  id              String   @id @default(cuid())
  
  // Machine reference
  machineId       String
  machine         WarehouseMachine @relation(fields: [machineId], references: [id])
  serialNumber    String
  
  // Technician/Specialist
  technicianId    String
  technicianName  String
  
  // Status tracking (Enhanced State Machine)
  status          String   @default("UNDER_MAINTENANCE")
  // UNDER_MAINTENANCE - جاري العمل (Initial state)
  // PENDING_APPROVAL - بانتظار موافقة الفرع
  // APPROVED - تمت الموافقة (ready to complete)
  // REJECTED - تم الرفض (no repair)
  // COMPLETED - مكتمل
  
  // Proposed Parts (Quote - before approval) - JSON
  proposedParts   String?  // [{partId, name, quantity, unitPrice, total, isPaid}]
  proposedTotal   Float    @default(0)  // Unified name with Socket.IO
  
  // Used Parts (Actual consumption - after approval/direct) - JSON
  usedParts       String?  // [{partId, name, quantity, unitPrice, total, isPaid}]
  totalCost       Float    @default(0)  // Actual cost
  
  // Workflow tracking
  needsApproval   Boolean  @default(false)  // true if Request Approval clicked
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  
  // Resolution
  actionTaken     String?  // الإجراء المتخذ
  resolution      String?  // REPAIRED, SCRAPPED, RETURNED_AS_IS
  
  // Timestamps
  assignedAt      DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Customer info (from original request)
  customerId      String?
  customerName    String?
  requestId       String?  // Original maintenance request
  
  // Branch tracking (Enhanced - explicit center tracking)
  branchId        String?  // Legacy field - will be deprecated
  centerBranchId  String?  // مركز الصيانة الذي يقوم بالعمل (NEW - will become required)
  originBranchId  String   // الفرع الأصلي للماكينة
  
  // Logs
  logs            ServiceAssignmentLog[]
  
  // Composite index to prevent duplicate open assignments
  @@index([machineId, status])
  @@index([centerBranchId, status])
  @@index([originBranchId, status])
}

// سجل أحداث التعيين (Activity Log)
model ServiceAssignmentLog {
  id              String   @id @default(cuid())
  assignmentId    String
  assignment      ServiceAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  action          String
  // ASSIGNED - تم التعيين
  // STARTED - بدأ العمل
  // PARTS_PROPOSED - تم اقتراح قطع (Quote)
  // PARTS_ADDED - تم إضافة قطع فعلية
  // APPROVAL_REQUESTED - تم إرسال طلب موافقة
  // APPROVED - تمت الموافقة
  // REJECTED - تم الرفض
  // COMPLETED - مكتمل
  // RETURNED - تم الإرجاع
  
  details         String?  // JSON or text description
  performedBy     String
  performedById   String?
  performedAt     DateTime @default(now())
  
  @@index([assignmentId, performedAt])
}

// المستحقات على الفروع (Branch Debts - Renamed for clarity)
model BranchDebt {
  id              String   @id @default(cuid())
  
  // Reference to service assignment or other debt source
  type            String   // MAINTENANCE, TRANSFER, OTHER
  referenceId     String   // assignmentId, transferId, etc.
  machineSerial   String?
  
  // Customer info (if applicable)
  customerId      String?
  customerName    String?
  
  // Amount details
  amount          Float
  paidAmount      Float    @default(0)
  remainingAmount Float    // Computed: amount - paidAmount
  partsDetails    String?  // JSON of parts used (if maintenance)
  
  // Status
  status          String   @default("PENDING")
  // PENDING - معلق
  // PARTIALLY_PAID - مدفوع جزئياً
  // PAID - تم السداد كاملاً
  // WAIVED - تم الإعفاء
  
  // Branch references
  creditorBranchId String  // المستحق له (مركز الصيانة)
  debtorBranchId   String  // المستحق عليه (الفرع)
  
  // Payment tracking (filled when paid)
  receiptNumber   String?
  paymentPlace    String?
  paidAt          DateTime?
  paidBy          String?
  paidByUserId    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([debtorBranchId, status])
  @@index([creditorBranchId, status])
  @@index([type, referenceId])
}

// طلب موافقة الصيانة (من المركز للفرع) - Enhanced
model MaintenanceApprovalRequest {
  id              String   @id @default(cuid())
  
  // Assignment reference
  assignmentId    String   @unique  // One approval per assignment
  machineSerial   String
  
  // Customer info  
  customerId      String?
  customerName    String
  
  // Requested parts (Quote)
  proposedParts   String   // JSON: [{partId, name, quantity, unitPrice, total, isPaid}]
  proposedTotal   Float    // Unified name with ServiceAssignment
  
  // Technician notes
  diagnosis       String?  // تشخيص المشكلة
  notes           String?  // ملاحظات إضافية
  
  // Response
  status          String   @default("PENDING")
  // PENDING - معلق
  // APPROVED - موافق
  // REJECTED - مرفوض
  
  rejectionReason String?
  respondedBy     String?
  respondedById   String?
  respondedAt     DateTime?
  
  // Branch references
  centerBranchId  String   // مركز الصيانة الطالب
  originBranchId  String   // الفرع المطلوب منه الموافقة
  
  createdAt       DateTime @default(now())
  
  @@index([centerBranchId, status])
  @@index([originBranchId, status])
}
