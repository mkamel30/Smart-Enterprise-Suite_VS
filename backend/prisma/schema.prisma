generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                String   @id @default(cuid())
  uid               String?
  email             String?
  displayName       String?
  role              String?  @default("CS_AGENT")
  canDoMaintenance  Boolean  @default(false)
  password          String?
  theme             String?  @default("light")
  fontFamily        String?  @default("sans-serif")
  fontSize          String?  @default("medium")
  highlightEffect   Boolean  @default(true)
  notificationSound Boolean  @default(true)
  mobilePush        Boolean  @default(false)
  createdAt         DateTime @default(now())
  branchId          String?
  branch            Branch?  @relation(fields: [branchId], references: [id])
}

model ClientType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
}

model Branch {
  id                  String                @id @default(cuid())
  code                String                @unique
  name                String
  address             String?
  type                String                @default("BRANCH")
  isActive            Boolean               @default(true)
  parentBranchId      String?
  maintenanceCenterId String?
  createdAt           DateTime              @default(now())
  maintenanceCenter   Branch?               @relation("BranchToCenter", fields: [maintenanceCenterId], references: [id])
  servicedBranches    Branch[]              @relation("BranchToCenter")
  parentBranch        Branch?               @relation("BranchHierarchy", fields: [parentBranchId], references: [id])
  childBranches       Branch[]              @relation("BranchHierarchy")
  customers           Customer[]
  installments        Installment[]
  inventory           InventoryItem[]
  machineMovements    MachineMovementLog[]
  sales               MachineSale[]
  approvals           MaintenanceApproval[]
  requests            MaintenanceRequest[]
  notifications       Notification[]
  payments            Payment[]
  posMachines         PosMachine[]
  vouchers            RepairVoucher[]
  simCards            SimCard[]
  simMovements        SimMovementLog[]
  stockMovements      StockMovement[]
  systemLogs          SystemLog[]
  receivedTransfers   TransferOrder[]       @relation("ReceivedTransfers")
  sentTransfers       TransferOrder[]       @relation("SentTransfers")
  usedPartLogs        UsedPartLog[]
  users               User[]
  warehouseMachines   WarehouseMachine[]
  warehouseSims       WarehouseSim[]
}

model Customer {
  id              String               @id @default(cuid())
  bkcode          String               @unique
  client_name     String
  supply_office   String?
  operating_date  DateTime?
  address         String?
  contact_person  String?
  scanned_id_path String?
  national_id     String?
  dept            String?
  telephone_1     String?
  telephone_2     String?
  has_gates       Boolean?             @default(false)
  bk_type         String?
  notes           String?
  papers_date     DateTime?
  isSpecial       Boolean?             @default(false)
  clienttype      String?
  branchId        String?
  branch          Branch?              @relation(fields: [branchId], references: [id])
  sales           MachineSale[]
  requests        MaintenanceRequest[]
  payments        Payment[]
  machines        PosMachine[]
  simCards        SimCard[]
}

model MachineParameter {
  id           String @id @default(cuid())
  prefix       String @unique
  model        String
  manufacturer String
}

model RolePermission {
  id             String   @id @default(cuid())
  role           String
  permissionType String
  permissionKey  String
  isAllowed      Boolean  @default(true)
  updatedAt      DateTime @updatedAt
  updatedBy      String?

  @@unique([role, permissionType, permissionKey])
}

model SparePart {
  id               String          @id @default(cuid())
  partNumber       String?
  name             String
  description      String?
  compatibleModels String?
  defaultCost      Float           @default(0)
  isConsumable     Boolean?        @default(false)
  allowsMultiple   Boolean?        @default(false)
  inventoryItems   InventoryItem[]
}

model InventoryItem {
  id       String    @id @default(cuid())
  partId   String
  quantity Int       @default(0)
  minLevel Int       @default(0)
  location String?
  branchId String?
  part     SparePart @relation(fields: [partId], references: [id])
  branch   Branch?   @relation(fields: [branchId], references: [id])
}

model MaintenanceRequest {
  id                  String               @id @default(cuid())
  customerId          String
  posMachineId        String?
  customerName        String?
  machineModel        String?
  machineManufacturer String?
  serialNumber        String?
  status              String               @default("Open")
  branchId            String?
  servicedByBranchId  String?
  technician          String?
  notes               String?
  complaint           String?
  actionTaken         String?
  createdAt           DateTime             @default(now())
  closingUserId       String?
  closingUserName     String?
  closingTimestamp    DateTime?
  usedParts           String?
  receiptNumber       String?
  totalCost           Float?               @default(0)
  approval            MaintenanceApproval?
  customer            Customer             @relation(fields: [customerId], references: [bkcode])
  posMachine          PosMachine?          @relation(fields: [posMachineId], references: [id])
  branch              Branch?              @relation(fields: [branchId], references: [id])
  vouchers            RepairVoucher[]
}

model PriceChangeLog {
  id        String   @id @default(cuid())
  partId    String
  oldCost   Float
  newCost   Float
  changedAt DateTime @default(now())
  userId    String?
}

model UsedPartLog {
  id             String   @id @default(cuid())
  requestId      String
  customerId     String
  customerName   String?
  posMachineId   String?
  technician     String?
  closedByUserId String?
  closedAt       DateTime @default(now())
  parts          String
  receiptNumber  String?
  branchId       String?
  branch         Branch?  @relation(fields: [branchId], references: [id])
}

model StockMovement {
  id          String   @id @default(cuid())
  partId      String
  type        String
  quantity    Int
  reason      String?
  requestId   String?
  userId      String?
  performedBy String?
  branchId    String?
  createdAt   DateTime @default(now())
  branch      Branch?  @relation(fields: [branchId], references: [id])
}

model Payment {
  id            String    @id @default(cuid())
  customerId    String?
  customerName  String?
  requestId     String?
  amount        Float
  type          String?
  reason        String?
  paymentPlace  String?
  paymentMethod String?
  receiptNumber String?
  notes         String?
  userId        String?
  userName      String?
  branchId      String?
  createdAt     DateTime  @default(now())
  branch        Branch?   @relation(fields: [branchId], references: [id])
  customer      Customer? @relation(fields: [customerId], references: [bkcode])
}

model MachineMovementLog {
  id           String   @id @default(cuid())
  machineId    String?
  serialNumber String
  action       String
  details      String?
  performedBy  String?
  branchId     String?
  createdAt    DateTime @default(now())
  branch       Branch?  @relation(fields: [branchId], references: [id])
}

model SystemLog {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  action      String
  details     String?
  performedBy String?
  userId      String?
  branchId    String?
  createdAt   DateTime @default(now())
  branch      Branch?  @relation(fields: [branchId], references: [id])
}

model Installment {
  id            String      @id @default(cuid())
  saleId        String
  dueDate       DateTime
  amount        Float
  isPaid        Boolean     @default(false)
  paidAt        DateTime?
  description   String?
  paidAmount    Float?
  paymentPlace  String?
  receiptNumber String?
  branchId      String?
  sale          MachineSale @relation(fields: [saleId], references: [id])
  branch        Branch?     @relation(fields: [branchId], references: [id])
}

model MachineSale {
  id           String        @id @default(cuid())
  serialNumber String
  customerId   String
  saleDate     DateTime      @default(now())
  type         String
  totalPrice   Float
  paidAmount   Float
  status       String
  notes        String?
  branchId     String?
  installments Installment[]
  customer     Customer      @relation(fields: [customerId], references: [bkcode])
  branch       Branch?       @relation(fields: [branchId], references: [id])
}

model PosMachine {
  id           String               @id @default(cuid())
  serialNumber String               @unique
  posId        String?
  model        String?
  manufacturer String?
  customerId   String?
  isMain       Boolean?             @default(false)
  branchId     String?
  requests     MaintenanceRequest[]
  customer     Customer?            @relation(fields: [customerId], references: [bkcode])
  branch       Branch?              @relation(fields: [branchId], references: [id])
}

model SimCard {
  id           String    @id @default(cuid())
  serialNumber String    @unique
  type         String?
  customerId   String?
  branchId     String?
  customer     Customer? @relation(fields: [customerId], references: [bkcode])
  branch       Branch?   @relation(fields: [branchId], references: [id])
}

model WarehouseMachine {
  id                    String              @id @default(cuid())
  serialNumber          String              @unique
  model                 String?
  manufacturer          String?
  status                String              @default("NEW")
  resolution            String?
  notes                 String?
  importDate            DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  originalOwnerId       String?
  branchId              String?
  requestId             String?
  customerId            String?
  customerName          String?
  readyForPickup        Boolean             @default(false)
  currentAssignmentId   String?
  currentTechnicianId   String?
  currentTechnicianName String?
  originBranchId        String?
  proposedParts         String?
  proposedRepairNotes   String?
  proposedTotalCost     Float?              @default(0)
  repairNotes           String?
  totalCost             Float?              @default(0)
  usedParts             String?
  serviceAssignments    ServiceAssignment[]
  branch                Branch?             @relation(fields: [branchId], references: [id])
}

model WarehouseSim {
  id           String   @id @default(cuid())
  serialNumber String   @unique
  type         String?
  status       String   @default("NEW")
  notes        String?
  importDate   DateTime @default(now())
  updatedAt    DateTime @updatedAt
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
}

model SimMovementLog {
  id           String   @id @default(cuid())
  simId        String
  serialNumber String
  action       String
  details      String?
  performedBy  String?
  branchId     String?
  createdAt    DateTime @default(now())
  branch       Branch?  @relation(fields: [branchId], references: [id])
}

model TransferOrder {
  id               String              @id @default(cuid())
  orderNumber      String              @unique
  waybillNumber    String?
  branchId         String?
  fromBranchId     String
  toBranchId       String
  status           String              @default("PENDING")
  type             String
  driverName       String?
  driverPhone      String?
  notes            String?
  createdBy        String?
  createdByName    String?
  createdByUserId  String?
  receivedByUserId String?
  receivedAt       DateTime?
  receivedBy       String?
  receivedByName   String?
  rejectionReason  String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  toBranch         Branch              @relation("ReceivedTransfers", fields: [toBranchId], references: [id])
  fromBranch       Branch              @relation("SentTransfers", fields: [fromBranchId], references: [id])
  items            TransferOrderItem[]
}

model TransferOrderItem {
  id              String        @id @default(cuid())
  transferOrderId String
  serialNumber    String?
  type            String?
  model           String?
  manufacturer    String?
  isReceived      Boolean       @default(false)
  receivedAt      DateTime?
  notes           String?
  transferOrder   TransferOrder @relation(fields: [transferOrderId], references: [id], onDelete: Cascade)
}

model MaintenanceApproval {
  id          String             @id @default(cuid())
  requestId   String             @unique
  cost        Float
  parts       String
  status      String             @default("PENDING")
  notes       String?
  branchId    String?
  createdAt   DateTime           @default(now())
  respondedAt DateTime?
  respondedBy String?
  branch      Branch?            @relation(fields: [branchId], references: [id])
  request     MaintenanceRequest @relation(fields: [requestId], references: [id])
}

model RepairVoucher {
  id        String             @id @default(cuid())
  code      String             @unique
  requestId String
  type      String
  parts     String
  totalCost Float
  branchId  String?
  createdAt DateTime           @default(now())
  createdBy String?
  branch    Branch?            @relation(fields: [branchId], references: [id])
  request   MaintenanceRequest @relation(fields: [requestId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String?
  branchId  String?
  link      String?
  type      String
  title     String
  message   String
  data      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  branch    Branch?  @relation(fields: [branchId], references: [id])
}

model ServiceAssignment {
  id              String                 @id @default(cuid())
  machineId       String
  serialNumber    String
  technicianId    String
  technicianName  String
  status          String                 @default("UNDER_MAINTENANCE")
  proposedParts   String?
  proposedTotal   Float                  @default(0)
  usedParts       String?
  totalCost       Float                  @default(0)
  needsApproval   Boolean                @default(false)
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  actionTaken     String?
  resolution      String?
  assignedAt      DateTime               @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  customerId      String?
  customerName    String?
  requestId       String?
  branchId        String?
  centerBranchId  String?
  originBranchId  String
  machine         WarehouseMachine       @relation(fields: [machineId], references: [id])
  logs            ServiceAssignmentLog[]

  @@index([machineId, status])
  @@index([centerBranchId, status])
  @@index([originBranchId, status])
}

model ServiceAssignmentLog {
  id            String            @id @default(cuid())
  assignmentId  String
  action        String
  details       String?
  performedBy   String
  performedById String?
  performedAt   DateTime          @default(now())
  assignment    ServiceAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId, performedAt])
}

model BranchDebt {
  id               String    @id @default(cuid())
  type             String
  referenceId      String
  machineSerial    String?
  customerId       String?
  customerName     String?
  amount           Float
  paidAmount       Float     @default(0)
  remainingAmount  Float
  partsDetails     String?
  status           String    @default("PENDING")
  creditorBranchId String
  debtorBranchId   String
  receiptNumber    String?
  paymentPlace     String?
  paidAt           DateTime?
  paidBy           String?
  paidByUserId     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([debtorBranchId, status])
  @@index([creditorBranchId, status])
  @@index([type, referenceId])
}

model MaintenanceApprovalRequest {
  id              String    @id @default(cuid())
  assignmentId    String    @unique
  machineSerial   String
  customerId      String?
  customerName    String
  proposedParts   String
  proposedTotal   Float
  diagnosis       String?
  notes           String?
  status          String    @default("PENDING")
  rejectionReason String?
  respondedBy     String?
  respondedById   String?
  respondedAt     DateTime?
  centerBranchId  String
  originBranchId  String
  createdAt       DateTime  @default(now())

  @@index([centerBranchId, status])
  @@index([originBranchId, status])
}
