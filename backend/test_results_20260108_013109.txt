======================================================== 
 SMART ENTERPRISE SUITE - BACKEND TEST REPORT 
 Timestamp: 20260108_013109 
======================================================== 
 
[1/3] Running General Integration Tests (integration.test.js)... 
-------------------------------------------------------- 
  console.log
    [MetricsCache] Initializing metrics cache...

      at Object.log [as initializeCache] (services/metricsCache.js:308:17)

  console.log
    [MetricsCache] Starting metrics calculation...

      at log (services/metricsCache.js:50:13)

{"level":30,"time":"2026-01-07T23:31:14.910Z","name":"cs-dept-console","pid":25096,"hostname":"MKamel","env":"test","context":"Prisma","msg":"Starting a sqlite pool with 9 connections."}
{"level":30,"time":"2026-01-07T23:31:14.991Z","name":"cs-dept-console","pid":25096,"hostname":"MKamel","env":"test","req":{"id":2,"method":"GET","url":"/api/dashboard","query":{},"params":{},"headers":{"host":"127.0.0.1:50153","accept-encoding":"gzip, deflate","connection":"close"},"remoteAddress":"::ffff:127.0.0.1","remotePort":50154},"res":{"statusCode":200,"headers":{"content-security-policy":"default-src 'self';script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src 'self' data: https:;connect-src 'self';font-src 'self';object-src 'none';media-src 'self';frame-src 'self';base-uri 'self';form-action 'self';frame-ancestors 'self';script-src-attr 'none';upgrade-insecure-requests","cross-origin-embedder-policy":"require-corp","cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"cross-origin","origin-agent-cluster":"?1","referrer-policy":"strict-origin-when-cross-origin","strict-transport-security":"max-age=31536000; includeSubDomains; preload","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"DENY","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","vary":"Origin","access-control-allow-credentials":"true","ratelimit-policy":"100;w=900","ratelimit-limit":"100","ratelimit-remaining":"99","ratelimit-reset":"900","content-type":"application/json; charset=utf-8","content-length":"312","etag":"W/\"138-3ioUDngPhLxTFcjyYslZGs1wJl4\""}},"responseTime":24,"msg":"GET / 200"}
  console.log
    [MetricsCache] Metrics calculated in 307ms

      at log (services/metricsCache.js:230:17)

  console.log
    [MetricsCache] Cache initialized successfully

      at Object.log [as initializeCache] (services/metricsCache.js:310:17)

{"level":30,"time":"2026-01-07T23:31:15.020Z","name":"cs-dept-console","pid":25096,"hostname":"MKamel","env":"test","req":{"id":3,"method":"GET","url":"/api/machines","query":{},"params":{},"headers":{"host":"127.0.0.1:50155","accept-encoding":"gzip, deflate","connection":"close"},"remoteAddress":"::ffff:127.0.0.1","remotePort":50156},"res":{"statusCode":200,"headers":{"content-security-policy":"default-src 'self';script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src 'self' data: https:;connect-src 'self';font-src 'self';object-src 'none';media-src 'self';frame-src 'self';base-uri 'self';form-action 'self';frame-ancestors 'self';script-src-attr 'none';upgrade-insecure-requests","cross-origin-embedder-policy":"require-corp","cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"cross-origin","origin-agent-cluster":"?1","referrer-policy":"strict-origin-when-cross-origin","strict-transport-security":"max-age=31536000; includeSubDomains; preload","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"DENY","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","vary":"Origin","access-control-allow-credentials":"true","ratelimit-policy":"100;w=900","ratelimit-limit":"100","ratelimit-remaining":"98","ratelimit-reset":"900","content-type":"application/json; charset=utf-8","content-length":"2","etag":"W/\"2-l9Fw4VUO7kr8CvBlt4zaMCqXZ0w\""}},"responseTime":7,"msg":"GET /machines 200"}
{"level":30,"time":"2026-01-07T23:31:15.034Z","name":"cs-dept-console","pid":25096,"hostname":"MKamel","env":"test","req":{"id":4,"method":"GET","url":"/api/customers/lite","query":{},"params":{},"headers":{"host":"127.0.0.1:50157","accept-encoding":"gzip, deflate","connection":"close"},"remoteAddress":"::ffff:127.0.0.1","remotePort":50158},"res":{"statusCode":200,"headers":{"content-security-policy":"default-src 'self';script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src 'self' data: https:;connect-src 'self';font-src 'self';object-src 'none';media-src 'self';frame-src 'self';base-uri 'self';form-action 'self';frame-ancestors 'self';script-src-attr 'none';upgrade-insecure-requests","cross-origin-embedder-policy":"require-corp","cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"cross-origin","origin-agent-cluster":"?1","referrer-policy":"strict-origin-when-cross-origin","strict-transport-security":"max-age=31536000; includeSubDomains; preload","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"DENY","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","vary":"Origin","access-control-allow-credentials":"true","ratelimit-policy":"100;w=900","ratelimit-limit":"100","ratelimit-remaining":"97","ratelimit-reset":"900","content-type":"application/json; charset=utf-8","content-length":"2","etag":"W/\"2-l9Fw4VUO7kr8CvBlt4zaMCqXZ0w\""}},"responseTime":4,"msg":"GET /lite 200"}
{"level":30,"time":"2026-01-07T23:31:15.054Z","name":"cs-dept-console","pid":25096,"hostname":"MKamel","env":"test","req":{"id":5,"method":"GET","url":"/api/technicians","query":{},"params":{},"headers":{"host":"127.0.0.1:50159","accept-encoding":"gzip, deflate","connection":"close"},"remoteAddress":"::ffff:127.0.0.1","remotePort":50160},"res":{"statusCode":200,"headers":{"content-security-policy":"default-src 'self';script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src 'self' data: https:;connect-src 'self';font-src 'self';object-src 'none';media-src 'self';frame-src 'self';base-uri 'self';form-action 'self';frame-ancestors 'self';script-src-attr 'none';upgrade-insecure-requests","cross-origin-embedder-policy":"require-corp","cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"cross-origin","origin-agent-cluster":"?1","referrer-policy":"strict-origin-when-cross-origin","strict-transport-security":"max-age=31536000; includeSubDomains; preload","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"DENY","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","vary":"Origin","access-control-allow-credentials":"true","ratelimit-policy":"100;w=900","ratelimit-limit":"100","ratelimit-remaining":"96","ratelimit-reset":"900","content-type":"application/json; charset=utf-8","content-length":"675","etag":"W/\"2a3-jUn/+OH/B4TFC0I43hB0Kdc2mlw\""}},"responseTime":10,"msg":"GET / 200"}
{"level":30,"time":"2026-01-07T23:31:15.084Z","name":"cs-dept-console","pid":25096,"hostname":"MKamel","env":"test","req":{"id":6,"method":"GET","url":"/api/machine-workflow/kanban","query":{},"params":{},"headers":{"host":"127.0.0.1:50161","accept-encoding":"gzip, deflate","connection":"close"},"remoteAddress":"::ffff:127.0.0.1","remotePort":50162},"res":{"statusCode":200,"headers":{"content-security-policy":"default-src 'self';script-src 'self' 'unsafe-inline';style-src 'self' 'unsafe-inline';img-src 'self' data: https:;connect-src 'self';font-src 'self';object-src 'none';media-src 'self';frame-src 'self';base-uri 'self';form-action 'self';frame-ancestors 'self';script-src-attr 'none';upgrade-insecure-requests","cross-origin-embedder-policy":"require-corp","cross-origin-opener-policy":"same-origin","cross-origin-resource-policy":"cross-origin","origin-agent-cluster":"?1","referrer-policy":"strict-origin-when-cross-origin","strict-transport-security":"max-age=31536000; includeSubDomains; preload","x-content-type-options":"nosniff","x-dns-prefetch-control":"off","x-download-options":"noopen","x-frame-options":"DENY","x-permitted-cross-domain-policies":"none","x-xss-protection":"0","vary":"Origin","access-control-allow-credentials":"true","ratelimit-policy":"100;w=900","ratelimit-limit":"100","ratelimit-remaining":"95","ratelimit-reset":"900","content-type":"application/json; charset=utf-8","content-length":"2","etag":"W/\"2-l9Fw4VUO7kr8CvBlt4zaMCqXZ0w\""}},"responseTime":18,"msg":"GET /kanban 200"}
PASS tests/integration.test.js
  Backend Integration API
    ‚àö GET /health returns 200 (121 ms)
    ‚àö GET /api/dashboard returns structured data (47 ms)
    ‚àö GET /api/machines returns array (26 ms)
    ‚àö GET /api/customers/lite returns simplified list (14 ms)
    ‚àö GET /api/technicians returns list (19 ms)
    ‚àö GET /api/machine-workflow/kanban returns board data (29 ms)

Test Suites: 1 passed, 1 total
Tests:       6 passed, 6 total
Snapshots:   0 total
Time:        4.021 s
Ran all test suites matching tests/integration.test.js.

Jest has detected the following 1 open handle potentially keeping Jest from exiting:

  ‚óè  Timeout

    [0m [90m 317 |[39m
     [90m 318 |[39m [90m// Refresh metrics cache every 5 minutes[39m
    [31m[1m>[22m[39m[90m 319 |[39m cron[33m.[39mschedule([32m'*/5 * * * *'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m     |[39m      [31m[1m^[22m[39m
     [90m 320 |[39m   logger[33m.[39mdebug([32m'Refreshing metrics cache...'[39m)[33m;[39m
     [90m 321 |[39m   [36mtry[39m {
     [90m 322 |[39m     [36mawait[39m metricsCache[33m.[39mcalculateAllMetrics()[33m;[39m[0m

      at Runner.start (node_modules/node-cron/src/scheduler/runner.ts:167:29)
      at InlineScheduledTask.start (node_modules/node-cron/src/tasks/inline-scheduled-task.ts:89:19)
      at Object.schedule (node_modules/node-cron/src/node-cron.ts:46:10)
      at Object.schedule (server.js:319:6)
      at Object.require (tests/integration.test.js:21:17)

  PASS 
 
[2/3] Running Transfer Service Tests (transferService.test.js)... 
-------------------------------------------------------- 
FAIL tests/transferService.test.js
  transferService
    createTransferOrder
      √ó should create a transfer order within a transaction (22 ms)
      √ó should rollback if an error occurs during creation (27 ms)
    receiveTransferOrder
      √ó should receive a transfer order within a transaction (3 ms)
      ‚àö should throw if order not found (2 ms)
      √ó should rollback if an error occurs during reception (3 ms)
    rejectOrder
      √ó should reject a transfer order within a transaction (4 ms)
      ‚àö should throw if order not found for rejection (2 ms)
      √ó should rollback if an error occurs during rejection (2 ms)
    cancelOrder
      √ó should cancel a transfer order within a transaction (3 ms)
      ‚àö should throw if order not found for cancellation (1 ms)
      √ó should rollback if an error occurs during cancellation (2 ms)

  ‚óè transferService ‚Ä∫ createTransferOrder ‚Ä∫ should create a transfer order within a transaction

    ÿ∏‚Äûÿ∑¬ß ÿ∑⁄æÿ∏ÀÜÿ∑¬¨ÿ∑¬Ø ÿ∑¬£ÿ∑¬µÿ∏‚Ä†ÿ∑¬ßÿ∏Ÿæ ÿ∏‚Äûÿ∏‚Äûÿ∑⁄æÿ∑¬≠ÿ∏ÀÜÿ∏Ÿπÿ∏‚Äû

    [0m [90m 69 |[39m
     [90m 70 |[39m     [36mif[39m ([33m![39mvalidation[33m.[39mvalid) {
    [31m[1m>[22m[39m[90m 71 |[39m         [36mconst[39m err [33m=[39m [36mnew[39m [33mError[39m(validation[33m.[39merrors[33m.[39mjoin([32m'\n'[39m))[33m;[39m
     [90m    |[39m                     [31m[1m^[22m[39m
     [90m 72 |[39m         err[33m.[39mstatus [33m=[39m [35m400[39m[33m;[39m
     [90m 73 |[39m         [36mthrow[39m err[33m;[39m
     [90m 74 |[39m     }[0m

      at createTransferOrder (services/transferService.js:71:21)
      at Object.<anonymous> (tests/transferService.test.js:118:28)

  ‚óè transferService ‚Ä∫ createTransferOrder ‚Ä∫ should rollback if an error occurs during creation

    expect(received).rejects.toThrow(expected)

    Expected substring: "Database error"
    Received message:   "ÿ∏‚Äûÿ∑¬ß ÿ∑⁄æÿ∏ÀÜÿ∑¬¨ÿ∑¬Ø ÿ∑¬£ÿ∑¬µÿ∏‚Ä†ÿ∑¬ßÿ∏Ÿæ ÿ∏‚Äûÿ∏‚Äûÿ∑⁄æÿ∑¬≠ÿ∏ÀÜÿ∏Ÿπÿ∏‚Äû"

        [0m [90m 69 |[39m
         [90m 70 |[39m     [36mif[39m ([33m![39mvalidation[33m.[39mvalid) {
        [31m[1m>[22m[39m[90m 71 |[39m         [36mconst[39m err [33m=[39m [36mnew[39m [33mError[39m(validation[33m.[39merrors[33m.[39mjoin([32m'\n'[39m))[33m;[39m
         [90m    |[39m                     [31m[1m^[22m[39m
         [90m 72 |[39m         err[33m.[39mstatus [33m=[39m [35m400[39m[33m;[39m
         [90m 73 |[39m         [36mthrow[39m err[33m;[39m
         [90m 74 |[39m     }[0m

      at createTransferOrder (services/transferService.js:71:21)
      at Object.<anonymous> (tests/transferService.test.js:159:13)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (tests/transferService.test.js:159:80)

  ‚óè transferService ‚Ä∫ receiveTransferOrder ‚Ä∫ should receive a transfer order within a transaction

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 226 |[39m             db[33m.[39mtransferOrder[33m.[39mfindFirst[33m.[39mmockResolvedValueOnce({ [33m...[39mmockTransferOrder[33m,[39m status[33m:[39m [32m'RECEIVED'[39m })[33m;[39m
     [90m 227 |[39m             [36mconst[39m result [33m=[39m [36mawait[39m receiveTransferOrder(transferOrderId[33m,[39m {}[33m,[39m mockUser)[33m;[39m
    [31m[1m>[22m[39m[90m 228 |[39m             expect(txUsed[33m.[39mwarehouseMachine[33m.[39mupdateMany)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                                                        [31m[1m^[22m[39m
     [90m 229 |[39m             expect(result[33m.[39mstatus)[33m.[39mtoBe([32m'RECEIVED'[39m)[33m;[39m
     [90m 230 |[39m         })[33m;[39m
     [90m 231 |[39m[0m

      at Object.toHaveBeenCalled (tests/transferService.test.js:228:56)

  ‚óè transferService ‚Ä∫ receiveTransferOrder ‚Ä∫ should rollback if an error occurs during reception

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

    [0m [90m 259 |[39m             expect(db[33m.[39m$transaction)[33m.[39mtoHaveBeenCalledTimes([35m1[39m)[33m;[39m
     [90m 260 |[39m             expect(db[33m.[39mtransferOrder[33m.[39mfindFirst)[33m.[39mtoHaveBeenCalledTimes([35m1[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 261 |[39m             expect(db[33m.[39mtransferOrder[33m.[39mupdate)[33m.[39mtoHaveBeenCalledTimes([35m1[39m)[33m;[39m
     [90m     |[39m                                             [31m[1m^[22m[39m
     [90m 262 |[39m             expect(db[33m.[39mwarehouseItem[33m.[39mupdateMany)[33m.[39mnot[33m.[39mtoHaveBeenCalled()[33m;[39m [90m// Should not have been called if update fails[39m
     [90m 263 |[39m             expect(db[33m.[39mnotification[33m.[39mcreate)[33m.[39mnot[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 264 |[39m         })[33m;[39m[0m

      at Object.toHaveBeenCalledTimes (tests/transferService.test.js:261:45)

  ‚óè transferService ‚Ä∫ rejectOrder ‚Ä∫ should reject a transfer order within a transaction

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"data": ObjectContaining {"status": "REJECTED"}, "include": Any<Object>, "where": {"id": "transfer1"}}

    Number of calls: 0

    [0m [90m 301 |[39m                 })
     [90m 302 |[39m             )[33m;[39m
    [31m[1m>[22m[39m[90m 303 |[39m             expect(db[33m.[39mtransferOrder[33m.[39mupdate)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                                             [31m[1m^[22m[39m
     [90m 304 |[39m                 expect[33m.[39mobjectContaining({
     [90m 305 |[39m                     where[33m:[39m { id[33m:[39m transferOrderId }[33m,[39m
     [90m 306 |[39m                     data[33m:[39m expect[33m.[39mobjectContaining({ status[33m:[39m [32m'REJECTED'[39m })[33m,[39m[0m

      at Object.toHaveBeenCalledWith (tests/transferService.test.js:303:45)

  ‚óè transferService ‚Ä∫ rejectOrder ‚Ä∫ should rollback if an error occurs during rejection

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"branchId": "branchA", "fromBranchId": "branchA", "id": "transfer1", "items": [{"id": "tItem1", "quantity": 1, "serialNumber": "SN123", "status": "IN_TRANSIT", "warehouseItemId": "item1"}], "status": "PENDING", "toBranchId": "branchB", "type": "MACHINE"}

    [0m [90m 349 |[39m             db[33m.[39mtransferOrder[33m.[39mupdate[33m.[39mmockRejectedValue(error)[33m;[39m
     [90m 350 |[39m
    [31m[1m>[22m[39m[90m 351 |[39m             [36mawait[39m expect(rejectOrder(transferOrderId[33m,[39m {}[33m,[39m mockUser))[33m.[39mrejects[33m.[39mtoThrow([32m'Rejection DB error'[39m)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 352 |[39m             [90m// Service calls $transaction twice for rejectOrder[39m
     [90m 353 |[39m             db[33m.[39mwarehouseMachine[33m.[39mupdate [33m=[39m jest[33m.[39mfn()[33m.[39mmockResolvedValue({})[33m;[39m
     [90m 354 |[39m             expect(db[33m.[39m$transaction)[33m.[39mtoHaveBeenCalledTimes([35m2[39m)[33m;[39m[0m

      at expect (node_modules/expect/build/index.js:2116:15)
      at Object.expect (tests/transferService.test.js:351:19)

  ‚óè transferService ‚Ä∫ cancelOrder ‚Ä∫ should cancel a transfer order within a transaction

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"where": {"id": "transfer1"}}
    Received: {"include": {"items": true}, "where": {"branchId": {"not": null}, "id": "transfer1"}}

    Number of calls: 1

    [0m [90m 389 |[39m             [90m// Service calls $transaction once for cancelOrder[39m
     [90m 390 |[39m             expect(db[33m.[39m$transaction)[33m.[39mtoHaveBeenCalledTimes([35m1[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 391 |[39m             expect(db[33m.[39mtransferOrder[33m.[39mfindFirst)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                                                [31m[1m^[22m[39m
     [90m 392 |[39m                 expect[33m.[39mobjectContaining({
     [90m 393 |[39m                     where[33m:[39m { id[33m:[39m transferOrderId }[33m,[39m
     [90m 394 |[39m                 })[0m

      at Object.toHaveBeenCalledWith (tests/transferService.test.js:391:48)

  ‚óè transferService ‚Ä∫ cancelOrder ‚Ä∫ should rollback if an error occurs during cancellation

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

    [0m [90m 463 |[39m             expect(db[33m.[39m$transaction)[33m.[39mtoHaveBeenCalledTimes([35m1[39m)[33m;[39m
     [90m 464 |[39m             expect(db[33m.[39mtransferOrder[33m.[39mfindFirst)[33m.[39mtoHaveBeenCalledTimes([35m1[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 465 |[39m             expect(db[33m.[39mtransferOrder[33m.[39mupdate)[33m.[39mtoHaveBeenCalledTimes([35m1[39m)[33m;[39m
     [90m     |[39m                                             [31m[1m^[22m[39m
     [90m 466 |[39m             expect(db[33m.[39mwarehouseItem[33m.[39mupdateMany)[33m.[39mnot[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 467 |[39m             expect(db[33m.[39mnotification[33m.[39mcreate)[33m.[39mnot[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m 468 |[39m         })[33m;[39m[0m

      at Object.toHaveBeenCalledTimes (tests/transferService.test.js:465:45)

Test Suites: 1 failed, 1 total
Tests:       8 failed, 3 passed, 11 total
Snapshots:   0 total
Time:        1.474 s, estimated 2 s
Ran all test suites matching tests/transferService.test.js.
  FAIL 
 
[3/3] Running Transfer Smoke Tests (transferService.smoke2.test.js)... 
-------------------------------------------------------- 
PASS tests/transferService.smoke2.test.js
  transferService smoke flows
    ‚àö creates a SIM transfer order (10 ms)
    ‚àö imports from excel requires buffer (3 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        1.112 s, estimated 2 s
Ran all test suites matching tests/transferService.smoke2.test.js.
  PASS 
 
======================================================== 
 TEST RUN COMPLETE 
======================================================== 
